 version: 2.1
 executors:
   test:
      environment:
        IMAGE_NAME: redwappin/projet1_ade
      docker:
        - image: circleci/buildpack-deps:stretch
 jobs:
   build:
     executor: test 
     steps:
       - checkout
       - setup_remote_docker # This environment is remote, fully-isolated and has been configured to execute Docker commands
       - run:
          name: Build docker image
          command: docker-compose -f ./docker-compose.yml build --compress --force-rm --no-cache --pull --parallel
       - run:
          name: Take a look to docker images
          command: docker images -a
       - run:
          name: Archive Docker image
          command: docker save -o image.tar project_api
       - persist_to_workspace:
          root: .
          paths:
            - ./image.tar.tar
   publish-tag:
      executor: test 
      steps:
        - setup_remote_docker
        - attach_workspace:
            at: /tmp/workspace
        - run:
           name: Load archived Docker image
           command: docker load -i /tmp/workspace/image.tar
        - run:
           name: Publish Docker Image to Docker Hub
           command: |
                echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
                #IMAGE_TAG=${CIRCLE_TAG/v/''}
                #docker tag project_api:latest $IMAGE_NAME:$IMAGE_TAG
                docker push $IMAGE_NAME:latest
                #docker push $IMAGE_NAME:$IMAGE_TAG
 workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: master
      - publish-tag:
          requires:
            - build
          filters:
            branches:
              only: master
      