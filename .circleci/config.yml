 version: 2.1
 executors:
   test:
      environment:
        IMAGE_NAME: redwappin/projet1_ade
      docker:
        - image: circleci/buildpack-deps:trusty
 jobs:
   build:
     executor: test 
     steps:
       - checkout
       - setup_remote_docker # This environment is remote, fully-isolated and has been configured to execute Docker commands
       - run:
          name: Build docker image
          command: docker-compose -f ./docker-compose.yml build --compress --force-rm --no-cache --pull --parallel
       - run:
          name: Take a look to docker images
          command: docker images -a
       - run:
          name: Archive Docker image
          command: docker save -o ./${PROJECT_NAME}_test.tar project_api
       - persist_to_workspace:
          root: .
          paths:
            - ./*.tar
   publish-tag:
      executor: test 
      steps:
        - setup_remote_docker
        - attach_workspace:
            at: /tmp/workspace
        - run:
           name: Load archived Docker image
           command: docker load -i /tmp/workspace/${PROJECT_NAME}_test.tar
        - run:
           name: What is circle tag?
           command: |
                IMAGE_TAG="latest"
                if [ "${CIRCLE_TAG}" == "" ];
                then
                  IMAGE_TAG=$CIRCLE_BUILD_NUM 
                else
                  IMAGE_TAG=${CIRCLE_TAG/v/''} 
                fi
                    # if [ $CIRCLE_TAG == "" ] 
                    # then IMAGE_TAG=$CIRCLE_BUILD_NUM 
                    # else IMAGE_TAG=${CIRCLE_TAG/v/''} 
                    # fi
                    # echo $IMAGE_TAG
        - run:
           name: Publish Docker Image to Docker Hub
           command: |
                echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
                docker tag project_api:latest redwappin/projet1_ade:$IMAGE_TAG
                docker push redwappin/projet1_ade:$IMAGE_TAG

 workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: master
      - publish-tag:
          requires:
            - build
          filters:
            branches:
              only: master
      